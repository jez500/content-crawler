<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta content="width=device-width,initial-scale=1,minimal-ui" name="viewport">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700,400italic|Material+Icons">
  <link rel="stylesheet" href="https://unpkg.com/vue-material@beta/dist/vue-material.min.css">
  <link rel="stylesheet" href="https://unpkg.com/vue-material@beta/dist/theme/default.css">
  <style>
    .md-card {
      margin-bottom: 1em;
    }
    h1 {
      text-transform: uppercase;
    }
    .md-app {
      height: 100vh;
    }
    .imagelist,
    .renderjson {
      height: 60vh ! important;
      overflow: auto ! important;
    }
    md-app {
      display: none;
    }
    .image--preview {
      max-height: 5em;
    }
    .log--crawler {
      max-height: 20em;
      overflow: auto;
      background-color: #efefef ! important;
    }
    .md-drawer {
      width: 300px;
      max-width: calc(100vw - 125px);
    }
    #rawHTML, .message {
      padding-right: 2em;
      padding-left: 2em;
    }
    code {
      padding: 2px 3px;
      background: #eee;
      border-radius: 3px;
      border: 1px solid #ccc;
    }
    .data--paginate li.active {
      font-weight: 800;
    }
    .data--paginate li {
      list-style-type: none;
      display: inline;
      margin-right: 2em;
    }
  </style>
</head>

<body>
<div id="app">

  <div class="page-container">

    <md-app>
      <md-app-toolbar class="md-primary">
        <md-button class="md-icon-button" @click="toggleMenu" v-if="!menuVisible">
          <md-icon>menu</md-icon>
        </md-button>
        <span class="md-title">{{ results.domain }}</span>
      </md-app-toolbar>

      <md-app-drawer :md-active.sync="menuVisible" md-persistent="full">
        <md-toolbar class="md-transparent" md-elevation="0">
          <span class="md-title">Sites</span>

          <div class="md-toolbar-section-end">
            <md-button class="md-icon-button md-dense" @click="toggleMenu">
              <md-icon>keyboard_arrow_left</md-icon>
            </md-button>
          </div>
        </md-toolbar>

        <div v-if="indexLoaded">
        <md-list>
          <md-list-item>
            <h4 class="md-subhead">Shared</h4>
          </md-list-item>
          <md-list-item v-for="nav in index" @click="getSite(nav.file)" :key="nav.file">
            <md-icon>bookmark_border</md-icon>
            <span class="md-list-item-text"><a href='#'>{{ nav.title }}</a></span>
            <md-button class="md-icon-button" @click="removeSite(nav.title)"><md-icon>delete</md-icon></md-button>
          </md-list-item>
        </md-list>

        <md-list>
          <md-list-item>
            <h4 class="md-subhead">Local</h4>
          </md-list-item>
          <md-list-item v-for="nav in storage" :key="nav.file">
            <md-icon>bookmark_border</md-icon>
            <span class="md-list-item-text" @click="getStorage(nav.file)"><a href='#'>{{ nav.title }}</a></span>
            <md-button class="md-icon-button" @click="removeStorage(nav.title)"><md-icon>delete</md-icon></md-button>
          </md-list-item>
          <md-list-item>
          <md-button @click="homePage" class="md-raised md-button">
              Add new website
          </md-button>
          </md-list-item>
        </md-list>
        <div v-if="indexMaster">
        <md-list>
          <md-list-item>
            <h4 class="md-subhead">Clients</h4>
          </md-list-item>
          <md-list-item v-for="client in clients" :key="client.key">
            <md-icon>bookmark_border</md-icon>
            <span class="md-list-item-text">{{ client }}</span>
            <md-button class="md-icon-button" @click="removeClient(client)"><md-icon>delete</md-icon></md-button>
          </md-list-item>
          <md-list-item>
          <md-button @click="addClient" class="md-raised md-button">
              Add new client
          </md-button>
          </md-list-item>
        </md-list>
        </div>
        </div>

      </md-app-drawer>


      <md-app-content>

        <div v-if="indexLoaded && siteLoaded">

          <md-tabs :md-active-tab="activeTab" @md-changed="tabChanged">
          <md-tab md-label="Overview" id="overview">

          <md-table v-model="overview">

            <md-table-row slot="md-table-row" slot-scope="{ item }">
              <md-table-cell md-label="Title" md-sort-by="title">{{ item.title }}</md-table-cell>
              <md-table-cell md-label="Count" md-sort-by="url">{{ item.count }}</md-table-cell>
            </md-table-row>
          </md-table>


          <div v-if="!isServer">
            <md-button @click="moveSiteToServer" class="md-primary md-raised md-button">Move site to server</md-button>
          </div>

          </md-tab>
          <md-tab md-label="Pages" id="pages">

          <md-table v-model="paginatedPages">

            <md-table-row slot="md-table-row" slot-scope="{ item }">
              <md-table-cell md-label="Title" md-sort-by="title"><a :href="item.url" :title="item.body">{{ item.title }}</a></md-table-cell>
              <md-table-cell md-label="Url" md-sort-by="url">{{ item.url }}</md-table-cell>
              <md-table-cell md-label="Size" md-sort-by="size">{{ item.size }}KB</md-table-cell>
              <md-table-cell md-label="Images">{{ item.images .length }}</md-table-cell>
              <md-table-cell md-label="Forms">{{ item.forms.length }}</md-table-cell>
            </md-table-row>
          </md-table>
          <paginate
            :v-model="pagesCurrentPage"
            :click-handler="setPagesCurrentPage"
            :page-count="Math.floor(this.results.pages.length / this.perPage)"
            :page-range="3"
            :margin-pages="2"
            :class="'data--paginate'">
          </paginate>

          </md-tab>
          <md-tab md-label="Images" id="images">

          <div class="imglist">
          <div v-if="images.length">
          <md-table v-model="paginatedImages">

            <md-table-row slot="md-table-row" slot-scope="image">
              <md-table-cell md-label="Image">
                <md-card>
                  <md-card-media-cover md-solid>
                    <md-card-media>
                      <a :href="image.item.url"><img height="80" :src="image.item.proxyUrl" alt="Image"></a>
                    </md-card-media>
                    <md-card-area>
                      <md-card-header>
                        <div class="md-subhead">{{ image.item.url }}</div>
                      </md-card-header>
                    </md-card-area>
                  </md-card-media-cover>
                </md-card>
              </md-table-cell>
            </md-table-row>
          </md-table>
          </div>
          <paginate
            :v-model="imagesCurrentPage"
            :click-handler="setImagesCurrentPage"
            :page-count="Math.floor(this.results.images.length / this.perPage)"
            :page-range="3"
            :margin-pages="2"
            :class="'data--paginate'">
          </paginate>
          </div>
          <div v-if="!images.length">
            <span class="md-list-item-text message">None</span>
          </div>

          </md-tab>
          <md-tab md-label="Documents" id="documents">

          <div v-if="documents.length">
          <md-table v-model="paginatedDocuments">
            <md-table-row slot="md-table-row" slot-scope="doc">
              <md-table-cell md-label="Document" md-sort-by="image"><a :href="doc" target="_blank">{{ doc.item }}</a></md-table-cell>
            </md-table-row>
          </md-table>
          <paginate
            :v-model="documentsCurrentPage"
            :click-handler="setDocumentsCurrentPage"
            :page-count="Math.floor(this.results.documents.length / this.perPage)"
            :page-range="3"
            :margin-pages="2"
            :class="'data--paginate'">
          </paginate>
          </div>

          <div v-if="!documents.length">
            <span class="md-list-item-text message">None</span>
          </div>

          </md-tab>
          <md-tab md-label="Forms" id="forms">

          <div v-if="forms.length">
          <md-table v-model="paginatedForms">
            <md-table-row slot="md-table-row" slot-scope="form">
              <md-table-cell md-label="Form">
                <md-field>
                  <md-textarea id="raw" v-model="form.item" :readonly="true"></md-textarea>
                </md-field>
              </md-table-cell>
            </md-table-row>
          </md-table>
          <paginate
            :v-model="formsCurrentPage"
            :click-handler="setFormsCurrentPage"
            :page-count="Math.floor(this.results.forms.length / this.perPage)"
            :page-range="3"
            :margin-pages="2"
            :class="'data--paginate'">
          </paginate>
          </div>
          <div v-if="!forms.length">
            <span class="md-list-item-text message">None</span>
          </div>

          </md-tab>
          <md-tab md-label="JSON" ref="json-tab" id="json">

          <!-- Provide a way to extract the json so you can save it to a file -->
          <md-table>
            <div id="rawHTML">
              {{ updateJSON() }}
            </div>
            <md-field>
              <md-button @click="copyJsonToClipboard" class="md-primary">
                Copy to clipboard
              </md-button>
            </md-field>
          </md-table>

          </md-tab>
          </md-tabs>

        </div>

        <div v-if="!indexLoaded">
          <h2 class="md-title">Authenticate
          <img src='doghouse.jpg' width="80" alt="" role="presentation"/></h2>
          <p>To use this site you will require a valid login code.</p>
          <p>Enter the login code here</p>
          <div layout="row" layout-align="center center">
            <input class="md-field" v-model="authKey" type="text" name="authKey" size="12">
            <md-button @click="authenticate" class="md-primary">
              Login
            </md-button>
          </div>
        </div>
        <div v-else>
          <div v-if="!siteLoaded">
            <div v-if="!crawling">
            <h2 class="md-title">How to crawl a site</h2>
            <form id="crawl-settings" onsubmit="document.getElementById('crawl').click(); return false;">
              <p>
                Enter the address of a site to crawl and press "Crawl" to add it to the list.
              </p>
              <md-field>
                <label>URL</label>
                <md-input v-model="url" type="url"></md-input>
              </md-field>
              <md-field>
                <label>Use this CORS proxy to download files</label>
                <md-input v-model="proxy" type="url"></md-input>
              </md-field>
              <md-field>
                <label> Only download urls containing this string </label>
                <md-input v-model="urlFilter" type="text"></md-input>
              </md-field>
              <md-field>
                <label> Do not download urls containing this string </label>
                <md-input v-model="excludeFilter"></md-input>
              </md-field>
              <md-field>
                <label> Delay between fetching pages (seconds) </label>
                <md-input v-model="delay" type="number"></md-input>
              </md-field>
              <md-checkbox v-model="downloadImages"> Download images </md-checkbox>
              <md-checkbox v-model="robots"> Respect "robots.txt" policy file. </md-checkbox>
              <md-checkbox v-model="removeEmptyNodes"> Remove empty tags </md-checkbox>
              <md-checkbox v-model="removeAttributes"> Remove uncommon attributes </md-checkbox>
              <md-checkbox v-model="trimWhitespace"> Trim whitespace </md-checkbox>
              <md-checkbox v-model="simplifyStructure"> Simplify structure </md-checkbox>
              <md-checkbox v-model="removeDuplicates"> Remove duplicated content </md-checkbox>
            <md-field>
              <label>
                Map URLs to content types.
              </label>
              <md-textarea v-model="contentMapping" placeholder="

                  http://url/*/specific | product | article
                  http://url | other "></md-textarea>
            </md-field>
            <md-field>
              <label>
                Remove elements
              </label>
              <md-textarea v-model="removeElements" placeholder="nav, aside, .navbar, .Breadcrumbs, header, head, footer, script, oembed, noscript, style, iframe, object"></md-textarea>
            </md-field>


              <p>
              <md-button id="crawl" @click="beginCrawl" class="md-primary md-raised md-button">Crawl</md-button>
              </p>
            </form>
            </div>
            <div v-if="crawling">
            <h2 class="md-title">Crawling site: {{ url }} </h2>
            <md-content md-tag="center">
              <md-progress-spinner id="progress" md-mode="indeterminate" ></md-progress-spinner>
            </md-content>
            </div>
            <div class="log--crawler"> </div>
          </div>
        </div>

      </md-app-content>
    </md-app>

  </div>

</div>

<script src="bundle.js"></script>
<script src="https://unpkg.com/vue"></script>
<script src="https://unpkg.com/vue-material@beta"></script>
<script src="https://unpkg.com/vuejs-paginate@latest"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.11/lodash.min.js"></script>
<script>
  Vue.use(VueMaterial.default);
  Vue.component('paginate', VuejsPaginate);

  new Vue({
    el: '#app',
    data: {
      menuVisible: false,
      jsonDir: '/sites/',
      indexLoaded: false,
      siteLoaded: false,
      isServer: false,
      results: {},
      pages: [],
      overview: [],
      images: [],
      index: {},
      storage: {},
      clients: [],
      url: '',
      proxy: 'https://cors-anywhere.herokuapp.com/',
      downloadImages: false,
      urlFilter: '',
      excludeFilter: '',
      delay: 5,
      robots: true,
      crawling: false,
      indexMaster: false,
      removeEmptyNodes: true,
      removeAttributes: true,
      trimWhitespace: true,
      simplifyStructure: true,
      removeDuplicates: true,
      authKey: '',
      rawJSON: '',
      contentMapping: '',
      removeElements: 'nav, aside, .navbar, .Breadcrumbs, header, head, footer, script, oembed, noscript, style, iframe, object',
      domainToLoad: '',
      perPage: 10,
      pagesCurrentPage: 0,
      imagesCurrentPage: 0,
      documentsCurrentPage: 0,
      formsCurrentPage: 0,
      activeTab: 'overview',
    },
    computed: {
      paginatedPages: function() {
        let start = (this.pagesCurrentPage * this.perPage);
        if (start > this.pages.length) {
          this.pagesCurrentPage = 0;
        }
        return this.pages.slice(
          this.pagesCurrentPage * this.perPage,
          (this.pagesCurrentPage + 1) * this.perPage
        );
      },
      paginatedImages: function() {
        let start = (this.imagesCurrentPage * this.perPage);
        if (start > this.images.length) {
          this.imagesCurrentPage = 0;
        }
        return this.images.slice(
          this.imagesCurrentPage * this.perPage,
          (this.imagesCurrentPage + 1) * this.perPage
        );
      },
      paginatedForms: function() {
        let start = (this.formsCurrentPage * this.perPage);
        if (start > this.forms.length) {
          this.formsCurrentPage = 0;
        }
        return this.forms.slice(
          this.formsCurrentPage * this.perPage,
          (this.formsCurrentPage + 1) * this.perPage
        );
      },
      paginatedDocuments: function() {
        let start = (this.documentsCurrentPage * this.perPage);
        if (start > this.documents.length) {
          this.documentsCurrentPage = 0;
        }
        return this.documents.slice(
          this.documentsCurrentPage * this.perPage,
          (this.documentsCurrentPage + 1) * this.perPage
        );
      },
    },
    methods: {
      setPagesCurrentPage: function(page) {
        this.pagesCurrentPage = page - 1;
      },
      setImagesCurrentPage: function(page) {
        this.imagesCurrentPage = page - 1;
      },
      setFormsCurrentPage: function(page) {
        this.formsCurrentPage = page - 1;
      },
      setDocumentsCurrentPage: function(page) {
        this.documentsCurrentPage = page - 1;
      },
      getOverview: function() {
        this.overview = [
          { title: 'Pages', count: this.results.pages.length, id: 'pages' },
          { title: 'Images', count: this.results.images.length, id: 'images' },
          { title: 'Documents', count: this.results.documents.length, id: 'documents' },
          { title: 'Forms', count: this.results.forms.length, id: 'forms' },
        ];
      },
      updateJSON: function() {
        setTimeout(function() {
          // Attach the JSON to the page.
          let raw = document.getElementById('rawHTML');
          if (raw) {
            while (raw.firstChild) {
              raw.removeChild(raw.firstChild);
            }
            raw.appendChild(this.rawHTML);
          }

        }.bind(this), 500);

        return '';
      },
      removeClient: function(key) {
        if (!this.indexMaster) {
          return [];
        }

        let params = new URLSearchParams();

        params.append('action', 'remove_client');
        params.append('key', key);
        params.append('authKey', this.authKey);

        axios.post('persist.php', params).then(() => {
          this.listClients();
        });

      },
      addClient: function() {
        if (!this.indexMaster) {
          return [];
        }

        let baseKey = prompt("Please enter the client ID", "client");

        if (!baseKey) {
          return [];
        }

        // Append a random string to the base key.
        let params = new URLSearchParams(),
            key = baseKey + '-' + Math.random().toString(36).substring(2, 8);

        params.append('action', 'add_client');
        params.append('key', key);
        params.append('authKey', this.authKey);

        axios.post('persist.php', params).then(() => {
          this.listClients();
        });

      },
      listClients: function() {
        if (!this.indexMaster) {
          return [];
        }

        let params = new URLSearchParams();

        params.append('action', 'list');
        params.append('authKey', this.authKey);

        axios.post('persist.php', params).then((data) => {
          this.clients = data.data;
        });

      },
      moveSiteToServer: function() {
        let params = new URLSearchParams();

        params.append('action', 'add');
        params.append('authKey', this.authKey);
        params.append('domain', this.results.domain);
        params.append('title', this.results.domain);
        params.append('json', this.rawJSON);

        axios.post('persist.php', params).then(() => {
          let site = this.results.domain;
          this.removeStorage(site);
          this.getSite(site + '.json');
        });
      },
      removeSite(site) {
        let params = new URLSearchParams();

        params.append('authKey', this.authKey);
        params.append('remove', this.results.domain);
        params.append('action', 'remove');

        axios.post('persist.php', params).then(() => {
          this.authenticate();
        });

      },
      authenticate() {
        if (!this.authKey) {
          return;
        }

        // Santize the key before we fetch it.
        this.authKey = this.authKey.replace(/[^A-Za-z0-9\-]/g, "");
        let timestamp = (new Date()).getTime();

        axios.get(this.jsonDir + this.authKey + '-index.json?' + timestamp, {})
          .then((data) => {
            this.indexLoaded = true;
            this.index = _.toArray(data.data);
            this.menuVisible = true;

            // The key was valid,
            // get the sites from local storage.
            let request = window.indexedDB.open('crawler');
            request.onupgradeneeded = function() {
              this.result.createObjectStore('files');
            }.bind(request);

            request.onsuccess = function() {
              let db = request.result;
              let tx = db.transaction('files', 'readonly');
              let st = tx.objectStore('files');
              let getRequest = st.get(this.jsonDir + this.authKey + '-index.json');

              getRequest.onsuccess = function() {
                this.storage = getRequest.result;
                if (this.domainToLoad) {
                  this.getStorage(this.domainToLoad);
                  this.domainToLoad = '';
                }
              }.bind(this);
            }.bind(this);
          }).then(() => {
            axios.get(this.jsonDir + this.authKey + '-index.json.master?' + timestamp, {})
            .then((data) => {
              this.indexMaster = true;
              this.listClients();
            });
          }).catch((boo) => {
            this.indexLoaded = false;
            this.index = [];
            alert('The login code was not correct. Please check it and try again.');
          });

      },
      toggleMenu() {
        this.menuVisible = !this.menuVisible
      },
      beginCrawl() {
        this.crawling = true;

        if (this.url.substring(0, 4) != 'http') {
          this.url = 'http://' + this.url;
        }

        window.crawl(this.url,
            this.downloadImages,
            this.urlFilter,
            this.excludeFilter,
            this.proxy,
            this.delay,
            this.robots,
            this.authKey,
            this.simplifyStructure,
            this.removeDuplicates,
            this.contentMapping,
            this.removeElements,
            this.crawlComplete);
      },
      crawlComplete() {
        this.crawling = false;
        let url = new URL(this.url);
        this.domainToLoad = url.hostname + '.json';
        this.authenticate();
      },
      getSite(file) {
        axios.get(this.jsonDir + file, {})
          .then((data) => {
            this.results = data.data;
            this.rawJSON = '';
            this.rawHTML = null;

            try {
              this.rawJSON = JSON.stringify(this.results);
              this.rawHTML = jsonToHtml(this.results);

            } catch (ex) { }

            this.pages = this.results.pages;
            this.images = this.results.images;
            this.documents = this.results.documents;
            this.forms = this.results.forms;
            this.getOverview();
            this.siteLoaded = true;
            this.isServer = true;

            this.resolveImages();
            this.selectDefaultTab();
          })
      },
      tabChanged: function(id) {
        this.activeTab = id;
      },
      selectDefaultTab() {
        setTimeout(function() {
          this.activeTab = 'overview';
        }.bind(this), 200);
      },
      getStorage(key) {
        let request = window.indexedDB.open('crawler');
        request.onupgradeneeded = function() {
          this.result.createObjectStore('files');
        }.bind(request);

        request.onsuccess = function() {
          let db = request.result;
          let tx = db.transaction('files', 'readonly');
          let st = tx.objectStore('files');
          let getRequest = st.get(this.jsonDir + key);

          getRequest.onsuccess = function() {
            let site = getRequest.result;

            this.results = site;
            this.rawJSON = JSON.stringify(this.results);
            this.rawHTML = jsonToHtml(this.results);
            this.pages = site.pages;
            this.images = site.images;
            this.documents = site.documents;
            this.forms = site.forms;
            this.getOverview();
            this.siteLoaded = true;
            this.isServer = false;
            this.resolveImages();
            this.selectDefaultTab();
          }.bind(this);
        }.bind(this);
      },
      resolveImages() {
        let index, img, loaded = 0;

        for (index in this.images) {
          img = this.images[index];

          // We would DOS the proxy if we load too many images at once.
          if (img.data.substring(0, 5) == 'data:') {
            img.proxyUrl = img.data;
          } else {
            loaded++;
            img.proxyUrl = this.proxy + img.data;
          }
        }
      },
      removeStorage(key) {
        let request = window.indexedDB.open('crawler');

        request.onsuccess = function() {
          let db = request.result;
          let tx = db.transaction('files', 'readwrite');
          let st = tx.objectStore('files');
          let deleteRequest = st.delete(this.jsonDir + key);

          deleteRequest.onsuccess = function() {
            delete this.storage[key];

            // Save the storage array.
            let putRequest = st.put(this.storage, this.jsonDir + this.authKey + '-index.json');

            putRequest.onsuccess = function() {
              this.authenticate();
            }.bind(this);
          }.bind(this);
        }.bind(this);
      },
      copyJsonToClipboard: function() {
        var source = document.createElement("textarea");
        document.body.appendChild(source);
        source.value = this.rawJSON;
        source.select();
        document.execCommand("copy");
        document.body.removeChild(source);
      },
      homePage() {
        this.results.domain = '';
        this.siteLoaded = false;
      },
    }
  });

  // Custom event listener to get log messages from the crawler.

  window.addEventListener('log--crawler', function(evt) {
    let logConsole = document.getElementsByClassName('log--crawler');

    if (logConsole) {
      let message = document.createTextNode(evt.message);
      let line = document.createElement('p');
      let code = document.createElement('code');
      code.appendChild(message);
      line.appendChild(code);
      logConsole = logConsole[0];
      logConsole.appendChild(line);
      logConsole.scrollTop = logConsole.scrollHeight;
    }
  });

</script>
</body>
</html>
